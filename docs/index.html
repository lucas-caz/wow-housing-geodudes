<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testemunhas de Geodude</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="grid-overlay.css">
    <style>
	  @import url('https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&display=swap');

	  body {
		font-family: Arial, sans-serif;
		background-color: #1b1b1b;
		color: #f5f5f5;
		margin: 0;
		display: flex;
		flex-direction: column;
		align-items: center;
		height: 100vh;
		overflow: hidden;
	  }

	  h1 {
		font-family: 'Cinzel Decorative', serif;
		font-size: 36px;
		color: #ffd35c;
		text-shadow: 0 0 10px #000, 0 0 20px #664b00;
		margin: 15px 0;
		letter-spacing: 2px;
	  }

	  .content {
		display: flex;
		justify-content: center;
		align-items: stretch;
		width: 100%;
		height: 100%;
		max-height: calc(100vh - 80px);
	  }

	  .map-container {
		flex: 1;
		display: flex;
		justify-content: center;
		align-items: center;
		overflow: hidden;
		position: relative;
		background-color: #1b1b1b;
	  }

	  .map-background {
		position: relative;
		width: 100%;
		height: 100%;
	  }

	  /* --- Painel lateral estilizado --- */
	  .side-panel {
		width: 280px;
		background: rgba(30, 30, 30, 0.95);
		padding: 20px;
		border-left: 3px solid #ffd35c;
		box-shadow: -4px 0 10px rgba(0, 0, 0, 0.6), 0 0 12px rgba(255, 211, 92, 0.2);
		border-radius: 12px 0 0 12px;
		overflow-y: auto;
	  }

	  .side-panel h3 {
		color: #ffd35c;
		text-align: center;
		font-size: 20px;
		margin-top: 0;
		margin-bottom: 15px;
		font-weight: 600;
		border-bottom: 1px solid rgba(255, 211, 92, 0.4);
		padding-bottom: 8px;
	  }

	  .occupied-item {
		font-size: 15px;
		margin-bottom: 8px;
		background: rgba(255, 255, 255, 0.05);
		border: 1px solid rgba(255, 211, 92, 0.2);
		border-radius: 6px;
		padding: 6px 10px;
		transition: background 0.2s;
	  }

	  .occupied-item:hover {
		background: rgba(255, 211, 92, 0.1);
	  }

	  .occupied-item strong {
		color: #ffd35c;
	  }

	  .occupied-item span {
		color: #fff;
	  }

	  .empty-message {
		font-size: 14px;
		color: #aaa;
		text-align: center;
		margin-top: 20px;
	  }

	  /* Scrollbar personalizada */
	  .side-panel::-webkit-scrollbar {
		width: 8px;
	  }

	  .side-panel::-webkit-scrollbar-thumb {
		background: #555;
		border-radius: 4px;
	  }

	  .side-panel::-webkit-scrollbar-thumb:hover {
		background: #777;
	  }
	</style>
</head>
<body>
    <h1>Testemunhas de Geodude - Layer 1</h1>

    <div class="content">
        <div class="map-container">
            <div class="map-background" id="mapBackground">
                <!-- Plots serão gerados aqui -->
            </div>
        </div>

        <div class="side-panel">
            <h3>Houses</h3>
            <div id="occupiedEntries"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getDatabase, ref, get, set, onValue } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCanbOEglqIz3VPHjp17yxnhQb_J437rug",
            authDomain: "wow-housing-geodudes.firebaseapp.com",
            projectId: "wow-housing-geodudes",
            storageBucket: "wow-housing-geodudes.firebasestorage.app",
            messagingSenderId: "748529193989",
            appId: "1:748529193989:web:142093f16125fe140bb86c",
            databaseURL: "https://wow-housing-geodudes-default-rtdb.firebaseio.com/"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Funções de integração com Firebase
        async function saveHousingData(data) {
            await set(ref(db, "housingData"), data);
        }

        function listenHousingData(callback) {
            const housingRef = ref(db, "housingData");
            onValue(housingRef, (snapshot) => {
                const value = snapshot.val() || {};
                callback(value);
            });
        }

        // Código principal do site
        let housingData = {};
        let plotPositions = [];
        let mapImageData = {};

        async function loadPlotPositions() {
            try {
                const response = await fetch("plot-positions.json");
                const data = await response.json();
                plotPositions = data.plotPositions;
                mapImageData = data.referenceImage;
            } catch (error) {
                console.error("Erro ao carregar plot-positions.json:", error);
                plotPositions = [];
            }
        }

        function createHousePlots() {
            const mapBackground = document.getElementById("mapBackground");
            mapBackground.innerHTML = "";

            plotPositions.forEach((position) => {
                const plot = document.createElement("div");
                plot.className = "house-plot";
                plot.textContent = position.plotNumber;

                const tooltip = document.createElement("div");
                tooltip.className = "plot-info";

                if (housingData[position.plotNumber]) {
                    plot.classList.add("occupied");
                    tooltip.textContent = `Plot ${position.plotNumber}: ${housingData[position.plotNumber]}`;
                } else {
                    tooltip.textContent = `Plot ${position.plotNumber}: Disponível`;
                }

                plot.appendChild(tooltip);
                plot.style.left = position.x + "px";
                plot.style.top = position.y + "px";
                plot.addEventListener("click", () => handlePlotClick(position.plotNumber));

                mapBackground.appendChild(plot);
            });

            updateOccupiedList();
        }

        async function handlePlotClick(plotNumber) {
            const currentName = housingData[plotNumber] || "";
            const newName = prompt(`Digite o nome para o plot ${plotNumber}:`, currentName);

            if (newName === null) return;

            if (newName.trim() === "") {
                delete housingData[plotNumber];
            } else {
                housingData[plotNumber] = newName.trim();
            }

            await saveHousingData(housingData);
        }

        function updateOccupiedList() {
            const container = document.getElementById("occupiedEntries");
            container.innerHTML = "";

            const occupied = Object.entries(housingData).sort((a, b) => a[0] - b[0]);

            if (occupied.length === 0) {
                container.innerHTML = '<div class="empty-message">Nenhum plot ocupado.</div>';
                return;
            }

            occupied.forEach(([plotNumber, name]) => {
                const item = document.createElement("div");
                item.className = "occupied-item";
                item.innerHTML = `<strong>#${plotNumber}</strong>: <span>${name}</span>`;
                container.appendChild(item);
            });
        }

        function updatePlotPositions() {
            const mapBackground = document.getElementById("mapBackground");
            const plots = document.querySelectorAll(".house-plot");
            if (plots.length === 0) return;

            const mapImage = new Image();
            mapImage.onload = function () {
                const mapRect = mapBackground.getBoundingClientRect();
                const containerWidth = mapRect.width;
                const containerHeight = mapRect.height;

                const imageAspectRatio = mapImage.width / mapImage.height;
                const containerAspectRatio = containerWidth / containerHeight;

                let imageWidth, imageHeight, offsetX, offsetY;

                if (imageAspectRatio > containerAspectRatio) {
                    imageWidth = containerWidth;
                    imageHeight = containerWidth / imageAspectRatio;
                    offsetX = 0;
                    offsetY = (containerHeight - imageHeight) / 2;
                } else {
                    imageHeight = containerHeight;
                    imageWidth = containerHeight * imageAspectRatio;
                    offsetX = (containerWidth - imageWidth) / 2;
                    offsetY = 0;
                }

                const scaleX = imageWidth / mapImage.width;
                const scaleY = imageHeight / mapImage.height;

                plots.forEach((plot, index) => {
                    const originalPos = plotPositions[index];
                    if (originalPos) {
                        const scaledX = offsetX + originalPos.x * scaleX;
                        const scaledY = offsetY + originalPos.y * scaleY;
                        plot.style.left = scaledX + "px";
                        plot.style.top = scaledY + "px";
                    }
                });
            };
            mapImage.src = "map.jpg";
        }

        document.addEventListener("DOMContentLoaded", async function () {
            await loadPlotPositions();

            // Atualiza quando Firebase muda
            listenHousingData((data) => {
                housingData = data;
                createHousePlots();
                updatePlotPositions();
            });

            window.addEventListener("resize", updatePlotPositions);
            setTimeout(updatePlotPositions, 100);
        });
    </script>

    <script src="grid-overlay.js"></script>
</body>
</html>
