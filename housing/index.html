<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testemunhas de Geodude</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="grid-overlay.css">
    <style> 
        body {
            font-family: Arial, sans-serif;
            background-color: #111;
            color: #fff;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        h1 {
            margin: 10px 0;
            font-size: 28px;
            color: #ffd35c;
            text-shadow: 0 0 10px #000;
        }

        .content {
            display: flex;
            justify-content: center;
            align-items: stretch;
            width: 100%;
            height: 100%;
            max-height: calc(100vh - 60px);
        }

        .map-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
        }

        .map-background {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .side-panel {
            width: 250px;
            background: rgba(0, 0, 0, 0.75);
            padding: 15px;
            border-left: 2px solid #333;
            overflow-y: auto;
        }

        .side-panel h3 {
            color: #ffd35c;
            margin-top: 0;
            text-align: center;
        }

        .occupied-item {
            font-size: 14px;
            margin-bottom: 6px;
            border-bottom: 1px solid #333;
            padding-bottom: 4px;
        }

        .occupied-item span {
            color: #ffd35c;
        }

        .empty-message {
            font-size: 13px;
            color: #aaa;
            text-align: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Testemunhas de Geodude - Layer 1</h1>

    <div class="content">
        <div class="map-container">
            <div class="map-background" id="mapBackground">
                <!-- Plots serão gerados aqui -->
            </div>
        </div>

        <div class="side-panel">
            <h3>Houses</h3>
            <div id="occupiedEntries"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getDatabase, ref, get, set, onValue } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCanbOEglqIz3VPHjp17yxnhQb_J437rug",
            authDomain: "wow-housing-geodudes.firebaseapp.com",
            projectId: "wow-housing-geodudes",
            storageBucket: "wow-housing-geodudes.firebasestorage.app",
            messagingSenderId: "748529193989",
            appId: "1:748529193989:web:142093f16125fe140bb86c",
            databaseURL: "https://wow-housing-geodudes-default-rtdb.firebaseio.com/"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Funções de integração com Firebase
        async function saveHousingData(data) {
            await set(ref(db, "housingData"), data);
        }

        function listenHousingData(callback) {
            const housingRef = ref(db, "housingData");
            onValue(housingRef, (snapshot) => {
                const value = snapshot.val() || {};
                callback(value);
            });
        }

        // Código principal do site
        let housingData = {};
        let plotPositions = [];
        let mapImageData = {};

        async function loadPlotPositions() {
            try {
                const response = await fetch("plot-positions.json");
                const data = await response.json();
                plotPositions = data.plotPositions;
                mapImageData = data.referenceImage;
            } catch (error) {
                console.error("Erro ao carregar plot-positions.json:", error);
                plotPositions = [];
            }
        }

        function createHousePlots() {
            const mapBackground = document.getElementById("mapBackground");
            mapBackground.innerHTML = "";

            plotPositions.forEach((position) => {
                const plot = document.createElement("div");
                plot.className = "house-plot";
                plot.textContent = position.plotNumber;

                const tooltip = document.createElement("div");
                tooltip.className = "plot-info";

                if (housingData[position.plotNumber]) {
                    plot.classList.add("occupied");
                    tooltip.textContent = `Plot ${position.plotNumber}: ${housingData[position.plotNumber]}`;
                } else {
                    tooltip.textContent = `Plot ${position.plotNumber}: Disponível`;
                }

                plot.appendChild(tooltip);
                plot.style.left = position.x + "px";
                plot.style.top = position.y + "px";
                plot.addEventListener("click", () => handlePlotClick(position.plotNumber));

                mapBackground.appendChild(plot);
            });

            updateOccupiedList();
        }

        async function handlePlotClick(plotNumber) {
            const currentName = housingData[plotNumber] || "";
            const newName = prompt(`Digite o nome para o plot ${plotNumber}:`, currentName);

            if (newName === null) return;

            if (newName.trim() === "") {
                delete housingData[plotNumber];
            } else {
                housingData[plotNumber] = newName.trim();
            }

            await saveHousingData(housingData);
        }

        function updateOccupiedList() {
            const container = document.getElementById("occupiedEntries");
            container.innerHTML = "";

            const occupied = Object.entries(housingData).sort((a, b) => a[0] - b[0]);

            if (occupied.length === 0) {
                container.innerHTML = '<div class="empty-message">Nenhum plot ocupado.</div>';
                return;
            }

            occupied.forEach(([plotNumber, name]) => {
                const item = document.createElement("div");
                item.className = "occupied-item";
                item.innerHTML = `<strong>#${plotNumber}</strong>: <span>${name}</span>`;
                container.appendChild(item);
            });
        }

        function updatePlotPositions() {
            const mapBackground = document.getElementById("mapBackground");
            const plots = document.querySelectorAll(".house-plot");
            if (plots.length === 0) return;

            const mapImage = new Image();
            mapImage.onload = function () {
                const mapRect = mapBackground.getBoundingClientRect();
                const containerWidth = mapRect.width;
                const containerHeight = mapRect.height;

                const imageAspectRatio = mapImage.width / mapImage.height;
                const containerAspectRatio = containerWidth / containerHeight;

                let imageWidth, imageHeight, offsetX, offsetY;

                if (imageAspectRatio > containerAspectRatio) {
                    imageWidth = containerWidth;
                    imageHeight = containerWidth / imageAspectRatio;
                    offsetX = 0;
                    offsetY = (containerHeight - imageHeight) / 2;
                } else {
                    imageHeight = containerHeight;
                    imageWidth = containerHeight * imageAspectRatio;
                    offsetX = (containerWidth - imageWidth) / 2;
                    offsetY = 0;
                }

                const scaleX = imageWidth / mapImage.width;
                const scaleY = imageHeight / mapImage.height;

                plots.forEach((plot, index) => {
                    const originalPos = plotPositions[index];
                    if (originalPos) {
                        const scaledX = offsetX + originalPos.x * scaleX;
                        const scaledY = offsetY + originalPos.y * scaleY;
                        plot.style.left = scaledX + "px";
                        plot.style.top = scaledY + "px";
                    }
                });
            };
            mapImage.src = "map.jpg";
        }

        document.addEventListener("DOMContentLoaded", async function () {
            await loadPlotPositions();

            // Atualiza quando Firebase muda
            listenHousingData((data) => {
                housingData = data;
                createHousePlots();
                updatePlotPositions();
            });

            window.addEventListener("resize", updatePlotPositions);
            setTimeout(updatePlotPositions, 100);
        });
    </script>

    <script src="grid-overlay.js"></script>
</body>
</html>
